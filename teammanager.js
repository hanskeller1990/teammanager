function get(e,t){call(e,null,t,"GET")}function post(e,t,n){call(e,t,n,"POST")}function put(e,t,n){call(e,t,n,"PUT")}function del(e,t){call(e,null,t,"DELETE")}function call(e,t,n,a){0!=e.indexOf("/")&&(e="/"+e),$.ajax({type:a,url:basePath+e,data:t,dataType:"json",beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+btoa(username+":"+password))},statusCode:{200:function(e){shouldBe401(e)&&"#login"!==window.location.hash&&"#login&ui-state=dialog"!==window.location.hash?logout(!0):n(e)}}})}function noError(e){return!e.type||"Info"===e.type}function shouldBe401(e){return e.type&&"Warning"===e.type&&"Benutzername und/oder Passwort ist ungültig."===e.message}function popup(e,t,n,a){$("#"+e+"-title").text(t),$("#"+e+"-text").text(n),$("#"+e).popup("open"),setTimeout(function(){$("#"+e).popup("close")},a)}function listTeams(e,t){$("tbody#"+e).empty(),get("teams",function(n){console.debug(n),n.forEach(function(n){if(memberId=memberIdOfUser(n.Members),!t||t&&memberId>0){var a="<tr><td>"+n.Name+'</td><td><a href="'+n.Website+'" target="_blank">'+n.Website+"</a></td>";memberId>0?a+='<td><button class="ui-btn ui-shadow ui-corner-all" onclick="austritt('+memberId+')">Austreten</button></td>':a+='<td><button class="ui-btn ui-shadow ui-corner-all" onclick="beitritt('+n.TeamId+')">Beitreten</button></td>',a+='<td><a href="#team-edit?teamId='+n.TeamId+'" data-role="button" data-icon="edit" data-iconpos="notext" data-theme="c" data-inline="true" class="ui-link ui-btn ui-btn-c ui-icon-edit ui-btn-icon-notext ui-btn-inline ui-shadow ui-corner-all">Edit</a></td></tr>'}$("tbody#"+e).append(a)},this)})}function beitritt(e){postData='{"UserId": '+userId+',"TeamId": '+e+"}",post("members",postData,function(e){listTeams("teamList")})}function austritt(e){del("members/"+e,function(e){listTeams("teamList")})}function getTeamDetail(e){e?($("#teamEditHeader").text("Team bearbeiten"),getTeam(e,function(e){showTeamDetail(e,e.OwnerId)})):($("#teamEditHeader").text("Neues Team erstellen"),showTeamDetail({},userId))}function showTeamDetail(e,t){get("users/"+t,function(t){t[0]&&($("#number-team-id").val(e.TeamId),$("#txt-team-owner").val(t[0].FirstName+" "+t[0].LastName),$("#txt-team-name").val(e.Name),$("#txt-team-website").val(e.Website),e.Members&&memberIdOfUser(e.Members)>0&&$("#chck-team-member").attr("checked",!0).checkboxradio("refresh"))}),e.TeamId?($("#btn-team-delete").show(),$("#teamDetailMembers").show(),listMembers(e.Members)):($("#btn-team-delete").hide(),$("#teamDetailMembers").hide())}function getTeam(e,t){get("teams/"+e,function(e){console.debug(e[0]),e[0]&&t(e[0])})}function listMembers(e){$("tbody#teamMembers").empty(),e.forEach(function(e){get("users/"+e.UserId,function(e){if(console.debug(e[0]),e[0]){user=e[0];var t="<tr><td>"+user.FirstName+"</td><td>"+user.LastName+"</td></tr>";$("tbody#teamMembers").append(t)}})})}function saveTeam(){let e={};e.TeamId=$("#number-team-id").val(),e.Name=$("#txt-team-name").val(),e.Website=$("#txt-team-website").val(),e.TeamId?put("teams/"+e.TeamId,JSON.stringify(e),function(e){console.debug(e)}):(e.OwnerId=userId,post("teams",JSON.stringify(e),function(e){$.mobile.changePage("#teams")}))}function deleteTeam(){teamId=$("#number-team-id").val(),del("teams/"+teamId,function(e){$.mobile.changePage("#teams")})}function memberIdOfUser(e){let t=0;return e.forEach(function(e){if(e.UserId==userId)return t=e.MemberId}),t}function ownTeams(e){let t=[];return e.forEach(function(e){e.OwnerId==userId&&t.push(e)}),t}function listTrainings(){$("tbody#trainingsList").empty(),teams=[],get("trainings",function(e){console.debug(e),noError(e)&&e.forEach(function(e){teams[e.TeamId]?writeTrainingsEntry("trainingsList",e):get("teams/"+e.TeamId,function(t){noError(t)&&(teams[e.TeamId]=t[0],writeTrainingsEntry("trainingsList",e))})})})}function listOwnTeamsTrainings(){$("tbody#teamTrainingsList").empty(),teams=[],get("trainings",function(e){console.debug(e),noError(e)&&e.forEach(function(e){teams[e.TeamId]?(memberId=memberIdOfUser(teams[e.TeamId].Members),memberId>0&&writeTrainingsEntry("teamTrainingsList",e)):get("teams/"+e.TeamId,function(t){noError(t)&&(teams[e.TeamId]=t[0],memberId=memberIdOfUser(t[0].Members),memberId>0&&writeTrainingsEntry("teamTrainingsList",e))})})})}function listOwnTrainings(){$("tbody#ownTrainingsList").empty(),teams=[],get("trainings",function(e){console.debug(e),noError(e)&&e.forEach(function(e){participantIdOfUser(e.Participants)>0&&(teams[e.TeamId]?writeTrainingsEntry("ownTrainingsList",e):get("teams/"+e.TeamId,function(t){noError(t)&&(teams[e.TeamId]=t[0],writeTrainingsEntry("ownTrainingsList",e))}))})})}function getTrainingDetail(e){e?($("#trainingEditHeader").text("Training bearbeiten"),getTraining(e,function(e){showTrainingDetail(e,e.TeamId)})):($("#trainingEditHeader").text("Neues Training erstellen"),showTrainingDetail({}))}function getTraining(e,t){get("trainings/"+e,function(e){console.debug(e[0]),e[0]&&t(e[0])})}function showTrainingDetail(e,t){t?get("teams/"+t,function(t){t[0]&&($("#number-training-id").val(e.TrainingId),$("#cmbx-training-teamid").append('<option value="'+t[0].TeamId+'">'+t[0].Name+"</option>"),$("#cmbx-training-teamid").selectedIndex=0,$("#cmbx-training-teamid").selectmenu("refresh"),$("#cmbx-training-teamid").attr("disabled",!0),$("#txt-training-title").val(e.Title),$("#txt-training-date").val(e.Date))}):get("teams",function(t){$("#number-training-id").val(e.TrainingId),ownTeams(t).forEach(function(e){$("#cmbx-training-teamid").append('<option value="'+e.TeamId+'">'+e.Name+"</option>")}),$("#txt-training-title").val(e.Title),$("#txt-training-date").val(e.Date)}),e.TrainingId?$("#btn-training-delete").show():$("#btn-training-delete").hide()}function saveTraining(){let e={};e.TrainingId=$("#number-training-id").val(),e.TeamId=$("#cmbx-training-teamid").val(),e.Title=$("#txt-training-title").val(),e.Date=$("#txt-training-date").val(),e.TrainingId?put("trainings/"+e.TrainingId,JSON.stringify(team),function(e){console.debug(e)}):post("trainings",JSON.stringify(e),function(e){$.mobile.changePage("#trainings")})}function anmelden(e){postData='{"UserId": '+userId+',"TrainingId": '+e+"}",callback=function(e){listTrainings()},"#own-teams-trainings"===window.location.hash&&(callback=function(e){listOwnTeamsTrainings()}),post("participants",postData,callback)}function abmelden(e){callback=function(e){listTrainings()},"#own-teams-trainings"===window.location.hash&&(callback=function(e){listOwnTeamsTrainings()}),del("participants/"+e,callback)}function writeTrainingsEntry(e,t){if(participantId=participantIdOfUser(t.Participants),participantId>0)n="<tr><td>"+t.Title+"</td><td>"+teams[t.TeamId].Name+"</td><td>"+t.Date+'</td><td><button class="ui-btn ui-shadow ui-corner-all" onclick="abmelden('+participantId+')">Abmelden</button></td><td>'+t.Participants.length+'</td><td><a href="#training-edit?trainingId='+t.TrainingId+'" data-role="button" data-icon="edit" data-iconpos="notext" data-theme="c" data-inline="true" class="ui-link ui-btn ui-btn-c ui-icon-edit ui-btn-icon-notext ui-btn-inline ui-shadow ui-corner-all">Edit</a></td></tr>';else var n="<tr><td>"+t.Title+"</td><td>"+teams[t.TeamId].Name+"</td><td>"+t.Date+'</td><td><button class="ui-btn ui-shadow ui-corner-all" onclick="anmelden('+t.TrainingId+')">Anmelden</button></td><td>'+t.Participants.length+'</td><td><a href="#training-edit?id='+t.TrainingId+'" data-role="button" data-icon="edit" data-iconpos="notext" data-theme="c" data-inline="true" class="ui-link ui-btn ui-btn-c ui-icon-edit ui-btn-icon-notext ui-btn-inline ui-shadow ui-corner-all">Edit</a></td></tr>';$("tbody#"+e).append(n)}function participantIdOfUser(e){let t=0;return e.forEach(function(e){if(e.UserId==userId)return t=e.ParticipantId}),t}function showUser(){get("users/"+userId,function(e){console.debug(e[0]),e[0]&&(user=e[0],$("#txt-settings-firstname").val(user.FirstName),$("#txt-settings-lastname").val(user.LastName),$("#txt-settings-mail").val(user.Email))})}function change(){if(firstname=$("#txt-settings-firstname").val(),lastname=$("#txt-settings-lastname").val(),mail=$("#txt-settings-mail").val(),""!==firstname&&""!==lastname&&""!==mail){var e={};e.FirstName=firstname,e.LastName=lastname,e.Email=mail,put("users/"+userId,JSON.stringify(e),function(e){noError(e)?(popup("settings-popup","Erfolg","Daten erfolgreich geändert",2e3),localName=localStorage.getItem("username"),localName&&localName!==mail&&localStorage.setItem("username",mail)):popup("settings-popup",e.type,e.message,2e3)})}else popup("settings-popup","Fehlende Angaben","Bitte füllen Sie alle Felder aus.",2e3)}function changePW(){password=$("#txt-settings-password").val(),passwordConfirm=$("#txt-settings-password-confirm").val(),""!==password&&""!==passwordConfirm?password===passwordConfirm?(putData={},putData.Password=password,put("users/"+userId,JSON.stringify(putData),function(e){noError(e)?(popup("settings-popup","Erfolg","Passwort erfolgreich geändert",2e3),localPW=localStorage.getItem("password"),localPW&&localPW!==password&&localStorage.setItem("password",password)):popup("settings-popup",e.type,e.message,2e3)})):popup("settings-popup","Fehler","Die Beiden Passwörter stimmen nicht überein",2e3):popup("settings-popup","Fehlende Angaben","Bitte füllen Sie alle Felder aus.",2e3)}function login(){username=$("#txt-login-username").val(),password=$("#txt-login-password").val(),saveCredentials=$("#chck-login-rememberme").is(":checked"),""!==username&&""!==password?get("users",function(e){console.debug(e),noError(e)?e.forEach(function(e){if(e.Email===username)return userId=e.UserId,saveCredentials&&(localStorage.setItem("username",username),localStorage.setItem("password",password),localStorage.setItem("userId",userId)),void(window.location.hash="")}):popup("login-popup",e.type,e.message,2e3)}):popup("login-popup","Fehlende Angaben","Bitte füllen Sie alle Felder aus.",2e3)}function signup(){if(firstname=$("#txt-signup-firstname").val(),lastname=$("#txt-signup-lastname").val(),mail=$("#txt-signup-mail").val(),password=$("#txt-signup-password").val(),passwordConfirm=$("#txt-signup-password-confirm").val(),""!==firstname&&""!==lastname&&""!==mail&&""!==password&&""!==passwordConfirm)if(password.length<8)popup("signup-popup","Fehler","Das Passwort muss mindestens 8 Zeichen lang sein",2e3);else if(password===passwordConfirm){var e={};e.FirstName=firstname,e.LastName=lastname,e.Email=mail,e.Password=password,post("register",JSON.stringify(e),function(e){noError(e)?(popup("signup-popup",e.type,e.message,2e3),$.mobile.changePage("#login")):popup("signup-popup",e.type,e.message,2e3)})}else popup("signup-popup","Fehler","Die Beiden Passwörter stimmen nicht überein",2e3);else popup("signup-popup","Fehlende Angaben","Bitte füllen Sie alle Felder aus.",2e3)}function logout(e){userId="",localStorage.clear(),$.mobile.changePage("#login?logout="+e)}var basePath="https://zbw.lump.ch/api/v1";$(function(){$("[data-role='navbar']").navbar(),$("[data-role='header'], [data-role='footer']").toolbar()}),$(document).on("pagecontainerchange",function(e,t){var n=window.location.hash;$("[data-role='navbar'] a.ui-btn-active").removeClass("ui-btn-active"),$("[data-role='navbar'] a").each(function(){($(this).attr("href")===n||""===n&&"#home"===$(this).attr("href"))&&$(this).addClass("ui-btn-active")})}),$(document).bind("pagebeforechange",function(e,t){$.mobile.pageData=t&&t.options&&t.options.pageData?t.options.pageData:null}),$(document).on("pagebeforeshow","#teams",function(){listTeams("teamList")}),$(document).on("pagebeforeshow","#ownTeams",function(){listTeams("ownTeamList",!0)}),$(document).on("pagebeforeshow","#team-edit",function(e,t){$.mobile.pageData?getTeamDetail($.mobile.pageData.teamId):getTeamDetail()}),$(document).on("pagebeforeshow","#trainings",function(){listTrainings()}),$(document).on("pagebeforeshow","#own-teams-trainings",function(){listOwnTeamsTrainings()}),$(document).on("pagebeforeshow","#ownTrainings",function(){listOwnTrainings()}),$(document).on("pagebeforeshow","#training-edit",function(e,t){$.mobile.pageData?getTrainingDetail($.mobile.pageData.trainingId):getTrainingDetail()});var teams,username,password,userId;$(document).bind("pagebeforechange",function(){"#login"!==window.location.hash&&"#signup"!==window.location.hash&&(username&&password&&userId||(username=localStorage.getItem("username"),password=localStorage.getItem("password"),userId=localStorage.getItem("userId"),username&&password&&userId||(window.location.hash="login")))}),$(document).on("pagebeforeshow","#settings",function(){showUser()}),$(document).on("pagebeforeshow","#login",function(e,t){$.mobile.pageData?"true"===$.mobile.pageData.logout?$("#logoutText").text("Sie wurden automatisch ausgeloggt. Bitte prüfen Sie Usernamen und Passwort und loggen Sie sich neu ein."):$("#logoutText").text("Sie haben sich erfolgreich ausgeloggt."):$("#logoutText").text("")}),function(e,t,n){function a(e){var t,a,i,s,o={},r=(e||"").replace(/^\?/,"").split(/&/);for(t=0;t<r.length;t++){var l=r[t];l&&(i=(a=l.split(/=/))[0],s=a[1],o[i]===n?o[i]=s:("object"!=typeof o[i]&&(o[i]=[o[i]]),o[i].push(s)))}return o}e(document).bind("pagebeforechange",function(t,n){if("string"==typeof n.toPage){var i=e.mobile.path.parseUrl(n.toPage);if(e.mobile.path.isEmbeddedPage(i)){var s=e.mobile.path.parseUrl(i.hash.replace(/^#/,""));s.search&&(n.options.dataUrl||(n.options.dataUrl=n.toPage),n.options.pageData=a(s.search),n.toPage=i.hrefNoHash+"#"+s.pathname)}}})}(jQuery,window);